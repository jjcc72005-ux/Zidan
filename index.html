<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GeoWorld â€” Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</title>

  <!-- Three.js Ùˆ D3.js Ù„Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.0.0/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-geo@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <!-- Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#11161a;
      --accent:#2bd4c8;
      --muted:#9aa6ad;
      --card:#172026;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Cairo",sans-serif;
      background:linear-gradient(180deg,#071014 0%, #0b1216 100%);
      color:#e7f6f4;
      height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    header{
      padding:12px 18px;
      background:rgba(0,0,0,0.25);
      border-bottom:1px solid rgba(255,255,255,0.03);
      flex-shrink: 0;
    }
    header h1{margin:0;font-size:18px}
    header p{margin:4px 0 0;color:var(--muted);font-size:13px}

    main{
      display:flex;
      gap:10px;
      height:calc(100vh - 74px);
      padding:10px;
      flex: 1;
      min-height: 0;
    }

    /* Sidebar */
    #sidebar{
      width:320px;
      background:var(--panel);
      border-radius:12px;
      padding:12px;
      box-shadow:0 6px 20px rgba(0,0,0,0.5);
      overflow:auto;
      flex-shrink: 0;
    }
    .controls{display:flex;gap:8px;margin-bottom:8px}
    #search{
      flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);
      background:transparent;color:inherit;
    }
    #region-filter{padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}

    #list-container{max-height:calc(100% - 60px);overflow:auto}
    #country-list{list-style:none;padding:0;margin:0}
    #country-list li{
      padding:8px;border-radius:8px;margin-bottom:6px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
      display:flex;align-items:center;gap:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.02);
      transition: all 0.2s ease;
    }
    #country-list li:hover {
      background: rgba(43, 212, 200, 0.1);
      border-color: rgba(43, 212, 200, 0.3);
    }
    .country-flag-thumb{width:36px;height:24px;border-radius:4px;object-fit:cover;border:1px solid rgba(0,0,0,0.4)}

    /* Globe */
    #globe-container{
      flex:1;
      border-radius:12px;
      overflow:hidden;
      position:relative;
      min-width: 0;
    }
    #globe{height:100%;width:100%}
    #globe-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      color: var(--muted);
      z-index: 10;
    }

    /* Modal */
    #country-modal.hidden{display:none}
    #country-modal{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;
      background:linear-gradient(180deg, rgba(2,6,8,0.6), rgba(2,6,8,0.6));
    }
    .modal-card{
      width:380px;background:var(--card);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);
      box-shadow:0 12px 40px rgba(0,0,0,0.6);position:relative;text-align:right;
      max-height: 90vh;
      overflow-y: auto;
    }
    #close-modal{position:absolute;left:12px;top:12px;background:#ff5f5f;border:0;color:white;border-radius:50%;width:36px;height:36px;font-size:20px;cursor:pointer}
    #modal-flag{width:100%;height:160px;object-fit:cover;border-radius:8px;margin-bottom:10px}
    .modal-card h2{margin:0 0 8px 0}
    .modal-card p{margin:6px 0;color:var(--muted);font-size:14px}
    #modal-more{display:inline-block;margin-top:8px;padding:8px 10px;border-radius:8px;background:var(--accent);color:#012; text-decoration:none;font-weight:600}

    /* Responsive */
    @media (max-width: 1200px) {
      #sidebar {
        width: 280px;
      }
    }
    
    @media (max-width: 900px){
      main {
        flex-direction: column;
        height: auto;
      }
      
      #sidebar {
        width: 100%;
        max-height: 40vh;
      }
      
      #globe-container {
        min-height: 50vh;
      }
    }
    
    @media (max-width: 600px){
      header h1 {
        font-size: 16px;
      }
      
      header p {
        font-size: 12px;
      }
      
      .modal-card {
        width: 95%;
        padding: 12px;
      }
      
      .controls {
        flex-direction: column;
      }
    }
    
    @media (max-width: 400px){
      main {
        padding: 5px;
        gap: 5px;
      }
      
      #sidebar {
        padding: 8px;
      }
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© */
    .country-label {
      position: absolute;
      color: white;
      font-family: 'Cairo', sans-serif;
      font-size: 12px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      pointer-events: none;
      white-space: nowrap;
      transition: opacity 0.3s;
      z-index: 5;
    }
    
    .country-label.highlight {
      color: var(--accent);
      font-weight: bold;
      font-size: 14px;
      text-shadow: 0 0 8px rgba(43, 212, 200, 0.8);
    }
    
    /* Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙ†Ù‚Ù„Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    #mobile-menu-toggle {
      display: none;
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: #012;
      font-size: 20px;
      cursor: pointer;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    @media (max-width: 900px) {
      #mobile-menu-toggle {
        display: block;
      }
      
      #sidebar.hidden-mobile {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒ GeoWorld â€” Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</h1>
    <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¯ÙˆÙ„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù„Ù…ØŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØªØµÙ†ÙŠÙ ØªÙ‚Ø¯ÙŠØ±ÙŠ.</p>
  </header>

  <main>
    <button id="mobile-menu-toggle">â˜°</button>
    
    <aside id="sidebar">
      <div class="controls">
        <input id="search" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙˆÙ„Ø© Ø¨Ø§Ù„Ø§Ø³Ù…..." />
        <select id="region-filter">
          <option value="">ÙƒÙ„ Ø§Ù„Ù‚Ø§Ø±Ø§Øª / Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
          <option value="Africa">Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
          <option value="Americas">Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØªØ§Ù†</option>
          <option value="Asia">Ø¢Ø³ÙŠØ§</option>
          <option value="Europe">Ø£ÙˆØ±ÙˆØ¨Ø§</option>
          <option value="Oceania">Ø£ÙˆÙ‚ÙŠØ§Ù†ÙˆØ³ÙŠØ§</option>
          <option value="Polar">Ø§Ù„Ù‚Ø·Ø¨</option>
        </select>
      </div>

      <div id="list-container">
        <p class="hint">Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        <ul id="country-list"></ul>
      </div>
    </aside>

    <section id="globe-container">
      <div id="globe"></div>
      <div id="globe-info">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©: ØªØ¯ÙˆÙŠØ±ØŒ ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ±</div>
    </section>
  </main>

  <!-- Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆÙ„Ø© -->
  <div id="country-modal" class="hidden">
    <div class="modal-card">
      <button id="close-modal" title="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
      <img id="modal-flag" alt="Ø¹Ù„Ù… Ø§Ù„Ø¯ÙˆÙ„Ø©" />
      <h2 id="modal-name"></h2>
      <p><strong>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Region / Subregion):</strong> <span id="modal-region"></span></p>
      <p><strong>ğŸ™ï¸ Ø§Ù„Ø¹Ø§ØµÙ…Ø©:</strong> <span id="modal-capital"></span></p>
      <p><strong>ğŸ‘¥ Ø§Ù„Ø³ÙƒØ§Ù†:</strong> <span id="modal-population"></span></p>
      <p><strong>ğŸ“ Ø§Ù„Ù…Ø³Ø§Ø­Ø© (ÙƒÙ…Â²):</strong> <span id="modal-area"></span></p>
      <p><strong>ğŸ’± Ø§Ù„Ø¹Ù…Ù„Ø©:</strong> <span id="modal-currency"></span></p>
      <p><strong>ğŸ“ Ø§Ù„Ù„ØºØ§Øª:</strong> <span id="modal-languages"></span></p>
      <p><strong>ğŸ“– Ù†Ø¨Ø°Ø© (Ù…ÙˆØ¬Ø²Ø©):</strong> <span id="modal-note"></span></p>
      <p><strong>âš–ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ (ØªÙ‚Ø¯ÙŠØ±ÙŠ):</strong> <span id="modal-classification"></span></p>
      <a id="modal-more" target="_blank" rel="noopener">Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (REST Countries)</a>
    </div>
  </div>

  <script>
    // === Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ===
    let scene, camera, renderer, globe, controls;
    let countriesData = [];
    let countryObjects = [];
    let countryLabels = [];

    function initGlobe() {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ù‡Ø¯
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x071014);

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 300;

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø±Ø¶
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(document.getElementById('globe').offsetWidth, document.getElementById('globe').offsetHeight);
      document.getElementById('globe').appendChild(renderer.domElement);

      // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.rotateSpeed = 0.5;

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¶ÙˆØ¡
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 3, 5);
      scene.add(directionalLight);

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©
      createGlobe();

      // Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…
      animate();
    }

    function createGlobe() {
      // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶
      const geometry = new THREE.SphereGeometry(100, 64, 64);
      const textureLoader = new THREE.TextureLoader();
      
      // ØªØ­Ù…ÙŠÙ„ Ù†Ø³ÙŠØ¬ Ø§Ù„Ø£Ø±Ø¶
      textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/earth_atmos_2048.jpg', function(texture) {
        const material = new THREE.MeshPhongMaterial({
          map: texture,
          specular: new THREE.Color(0x333333),
          shininess: 5
        });
        globe = new THREE.Mesh(geometry, material);
        scene.add(globe);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø­Ø¨
        textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/earth_clouds_1024.png', function(cloudTexture) {
          const cloudMaterial = new THREE.MeshPhongMaterial({
            map: cloudTexture,
            transparent: true,
            opacity: 0.4
          });
          const cloudGeometry = new THREE.SphereGeometry(101, 64, 64);
          const clouds = new THREE.Mesh(cloudGeometry, cloudMaterial);
          scene.add(clouds);
        });

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆÙ„ ÙˆØ±Ø³Ù… Ø­Ø¯ÙˆØ¯Ù‡Ø§
        loadCountriesData();
      });
    }

    function loadCountriesData() {
      const GEOJSON_URL = 'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json';
      
      fetch(GEOJSON_URL)
        .then(resp => resp.json())
        .then(geo => {
          countriesData = geo.features;
          drawCountryBorders(geo);
          createCountryLabels(geo);
          populateCountryList(geo.features);
        })
        .catch(err => {
          console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ GeoJSON:', err);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
        });
    }

    function drawCountryBorders(geoData) {
      const lineMaterial = new THREE.LineBasicMaterial({ color: 0x2bd4c8 });
      
      geoData.features.forEach(feature => {
        if (feature.geometry.type === 'Polygon') {
          feature.geometry.coordinates.forEach(polygon => {
            const points = [];
            polygon.forEach(coord => {
              const lat = coord[1];
              const lon = coord[0];
              const point = latLonToVector3(lat, lon, 100.5);
              points.push(point);
            });
            
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(geometry, lineMaterial);
            line.userData = { country: feature.properties };
            scene.add(line);
            countryObjects.push(line);
          });
        } else if (feature.geometry.type === 'MultiPolygon') {
          feature.geometry.coordinates.forEach(multiPolygon => {
            multiPolygon.forEach(polygon => {
              const points = [];
              polygon.forEach(coord => {
                const lat = coord[1];
                const lon = coord[0];
                const point = latLonToVector3(lat, lon, 100.5);
                points.push(point);
              });
              
              const geometry = new THREE.BufferGeometry().setFromPoints(points);
              const line = new THREE.Line(geometry, lineMaterial);
              line.userData = { country: feature.properties };
              scene.add(line);
              countryObjects.push(line);
            });
          });
        }
      });
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©
    function createCountryLabels(geoData) {
      // Ù…Ø³Ø­ Ø£ÙŠ ØªØ³Ù…ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©
      countryLabels.forEach(label => {
        if (label.element && label.element.parentNode) {
          label.element.parentNode.removeChild(label.element);
        }
      });
      countryLabels = [];
      
      geoData.features.forEach(feature => {
        const countryName = feature.properties.name || feature.properties.NAME || feature.properties.ADMIN || '';
        if (!countryName) return;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¯ÙˆÙ„Ø©
        const center = getFeatureCenter(feature);
        if (!center) return;
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ù†ØµÙŠ
        const label = document.createElement('div');
        label.className = 'country-label';
        label.textContent = countryName;
        label.style.display = 'none'; // Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
        
        // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ DOM
        document.getElementById('globe-container').appendChild(label);
        
        // Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø¬Ø¹
        countryLabels.push({
          element: label,
          country: feature.properties,
          center: center
        });
      });
      
      // ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ§Øª
      updateLabelPositions();
    }

    // ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¯ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    function updateLabelPositions() {
      countryLabels.forEach(labelInfo => {
        const label = labelInfo.element;
        const center = labelInfo.center;
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
        const position = latLonToVector3(center[0], center[1], 102);
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø´Ø§Ø´Ø©
        const vector = position.clone();
        vector.project(camera);
        
        const widthHalf = document.getElementById('globe').offsetWidth / 2;
        const heightHalf = document.getElementById('globe').offsetHeight / 2;
        
        const x = (vector.x * widthHalf) + widthHalf;
        const y = -(vector.y * heightHalf) + heightHalf;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªØ³Ù…ÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ Ù…Ù† Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©
        const isVisible = vector.z > 0 && vector.z <= 1;
        
        if (isVisible && x >= 0 && x <= document.getElementById('globe').offsetWidth && 
            y >= 0 && y <= document.getElementById('globe').offsetHeight) {
          label.style.display = 'block';
          label.style.left = x + 'px';
          label.style.top = y + 'px';
        } else {
          label.style.display = 'none';
        }
      });
    }

    function latLonToVector3(lat, lon, radius) {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lon + 180) * (Math.PI / 180);
      
      const x = -(radius * Math.sin(phi) * Math.cos(theta));
      const z = radius * Math.sin(phi) * Math.sin(theta);
      const y = radius * Math.cos(phi);
      
      return new THREE.Vector3(x, y, z);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
      updateLabelPositions();
    }

    // === Ø¹Ù†Ø§ØµØ± DOM ===
    const countryListEl = document.getElementById('country-list');
    const searchInput = document.getElementById('search');
    const regionFilter = document.getElementById('region-filter');
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const sidebar = document.getElementById('sidebar');

    const modal = document.getElementById('country-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const modalFlag = document.getElementById('modal-flag');
    const modalName = document.getElementById('modal-name');
    const modalRegion = document.getElementById('modal-region');
    const modalCapital = document.getElementById('modal-capital');
    const modalPopulation = document.getElementById('modal-population');
    const modalArea = document.getElementById('modal-area');
    const modalCurrency = document.getElementById('modal-currency');
    const modalLanguages = document.getElementById('modal-languages');
    const modalNote = document.getElementById('modal-note');
    const modalClassification = document.getElementById('modal-classification');
    const modalMore = document.getElementById('modal-more');

    // Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­ÙˆÙŠÙ„ subregion Ø¥Ù„Ù‰ ÙˆØµÙ Ø¹Ø±Ø¨ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ
    const subregionArabic = {
      "Southern Asia":"Ø¬Ù†ÙˆØ¨ Ø¢Ø³ÙŠØ§",
      "Western Asia":"ØºØ±Ø¨ Ø¢Ø³ÙŠØ§",
      "Central Asia":"Ø¢Ø³ÙŠØ§ Ø§Ù„ÙˆØ³Ø·Ù‰",
      "South-Eastern Asia":"Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚ Ø¢Ø³ÙŠØ§",
      "Eastern Europe":"Ø´Ø±Ù‚ Ø£ÙˆØ±ÙˆØ¨Ø§",
      "Northern Europe":"Ø´Ù…Ø§Ù„ Ø£ÙˆØ±ÙˆØ¨Ø§",
      "Southern Europe":"Ø¬Ù†ÙˆØ¨ Ø£ÙˆØ±ÙˆØ¨Ø§",
      "Western Europe":"ØºØ±Ø¨ Ø£ÙˆØ±ÙˆØ¨Ø§",
      "Northern Africa":"Ø´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§",
      "Sub-Saharan Africa":"Ø£ÙØ±ÙŠÙ‚ÙŠØ§ Ø¬Ù†ÙˆØ¨ Ø§Ù„ØµØ­Ø±Ø§Ø¡",
      "Caribbean":"Ø§Ù„ÙƒØ§Ø±ÙŠØ¨ÙŠ",
      "Central America":"Ø£Ù…Ø±ÙŠÙƒØ§ Ø§Ù„ÙˆØ³Ø·Ù‰",
      "South America":"Ø£Ù…Ø±ÙŠÙƒØ§ Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©",
      "Micronesia":"Ù…ÙŠÙƒØ±ÙˆÙ†ÙŠØ²ÙŠØ§",
      "Polynesia":"Ø¨ÙˆÙ„Ù†ÙŠØ³ÙŠØ§",
      "Melanesia":"Ù…ÙŠÙ„Ø§Ù†ÙŠØ³ÙŠØ§",
      "Australia and New Zealand":"Ø£Ø³ØªØ±Ø§Ù„ÙŠØ§ ÙˆÙ†ÙŠÙˆØ²ÙŠÙ„Ù†Ø¯Ø§",
      "Antarctica":"Ø§Ù„Ù‚Ø·Ø¨ Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠ"
    };

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¯ÙˆÙ„Ø©: Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ Ù…Ù† REST Countries ÙˆÙ†Ø¸Ù‡Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    async function onCountryClick(feature) {
      const props = feature.properties || {};
      let countryName = props.name || props.NAME || props.ADMIN || null;
      // Ø£ÙØ¶Ù„ Ø·Ø±ÙŠÙ‚Ø©: Ù†Ø¨Ø­Ø« Ø£ÙˆÙ„Ù‹Ø§ Ø¹Ù† Ø§Ù„Ù€ ISO_A3 Ø£Ùˆ ISO_A2
      const iso_a3 = props['iso_a3'] || props['ISO_A3'] || props['ISO3'] || null;
      const iso_a2 = props['iso_a2'] || props['ISO_A2'] || props['ISO_A2'] || null;

      try {
        let restData = null;

        if(iso_a2 && iso_a2.length === 2){
          // Ø¬Ù„Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ø¨Ù„Ø¯ (alpha2)
          restData = await fetchRestCountryByCode(iso_a2);
        }
        if(!restData && iso_a3 && iso_a3.length === 3){
          restData = await fetchRestCountryByCode(iso_a3);
        }
        if(!restData && countryName){
          // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (Ù‚Ø¯ ÙŠÙØ´Ù„ Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ù„ÙŠØ©)
          restData = await fetchRestCountryByName(countryName);
        }

        if(!restData){
          // Ù„Ùˆ Ù…ÙÙ‡ÙˆØ´ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† REST Countries Ù†Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
          showModalMinimal(countryName, feature);
          return;
        }

        showCountryModalFromRest(restData, feature);

      } catch (err){
        console.error('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆÙ„Ø©:', err);
        showModalMinimal(countryName, feature);
      }
    }

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† REST Countries Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯ (alpha2/alpha3)
    async function fetchRestCountryByCode(code){
      // REST Countries â€” v3.1
      const url = `https://restcountries.com/v3.1/alpha/${code}`;
      const r = await fetch(url);
      if(!r.ok) return null;
      const data = await r.json();
      return data && data[0] ? data[0] : null;
    }
    
    async function fetchRestCountryByName(name){
      const url = `https://restcountries.com/v3.1/name/${encodeURIComponent(name)}?fullText=true`;
      const r = await fetch(url);
      if(!r.ok){
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø­Ø« Ø¬Ø²Ø¦ÙŠ
        const r2 = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(name)}`);
        if(!r2.ok) return null;
        const d2 = await r2.json();
        return d2 && d2[0] ? d2[0] : null;
      }
      const data = await r.json();
      return data && data[0] ? data[0] : null;
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª REST Countries
    function showCountryModalFromRest(rc, feature){
      const commonName = rc.name && (rc.name.common || rc.name.official) || feature.properties.name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      modalName.textContent = commonName;

      // Ø¹Ù„Ù…
      const flagUrl = rc.flags && (rc.flags.png || rc.flags.svg) || '';
      modalFlag.src = flagUrl;
      modalFlag.alt = `Ø¹Ù„Ù… ${commonName}`;

      // region / subregion
      const region = rc.region || '';
      const subregion = rc.subregion || '';
      let regionText = region;
      if(subregion){
        regionText += ` â€” ${subregionArabic[subregion] || subregion}`;
      }
      modalRegion.textContent = regionText || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';

      // Ø§Ù„Ø¹Ø§ØµÙ…Ø©
      modalCapital.textContent = (rc.capital && rc.capital[0]) || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';

      // Ø§Ù„Ø³ÙƒØ§Ù†
      modalPopulation.textContent = rc.population ? numberWithCommas(rc.population) + ' Ù†Ø³Ù…Ø©' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';

      // Ø§Ù„Ù…Ø³Ø§Ø­Ø©
      modalArea.textContent = rc.area ? numberWithCommas(Math.round(rc.area)) : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';

      // Ø§Ù„Ø¹Ù…Ù„Ø§Øª
      if(rc.currencies){
        const curArr = Object.keys(rc.currencies).map(k => `${k} (${rc.currencies[k].name || ''})`);
        modalCurrency.textContent = curArr.join(', ');
      } else modalCurrency.textContent = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';

      // Ø§Ù„Ù„ØºØ§Øª
      if(rc.languages){
        modalLanguages.textContent = Object.values(rc.languages).join(', ');
      } else modalLanguages.textContent = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';

      // Ù†Ø¨Ø°Ø© Ù…ÙˆØ¬Ø²Ø© (Ù†Ù†Ø´Ø¦ Ø¬Ù…Ù„Ø© Ù‚ØµÙŠØ±Ø© Ù…Ù† Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…ØªØ§Ø­Ø©)
      let noteParts = [];
      if(rc.independent === true) noteParts.push('Ø¯ÙˆÙ„Ø© Ù…Ø³ØªÙ‚Ù„Ø©');
      if(rc.unMember === false) noteParts.push('Ù„ÙŠØ³Øª Ø¹Ø¶ÙˆÙ‹Ø§ ÙÙŠ Ø§Ù„Ø£Ù…Ù… Ø§Ù„Ù…ØªØ­Ø¯Ø©');
      if(rc.capital && rc.capital.length) noteParts.push(`Ø¹Ø§ØµÙ…ØªÙ‡Ø§ ${rc.capital[0]}`);
      modalNote.textContent = noteParts.length ? noteParts.join(' â€¢ ') : 'â€”';

      // ØªØµÙ†ÙŠÙ ØªÙ‚Ø¯ÙŠØ±ÙŠ â€” Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù† (Ù…Ù†Ø·Ù‚ Ø¨Ø³ÙŠØ· ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù‚ØªØµØ§Ø¯ÙŠØ©)
      const classification = estimateClassification(rc.population, rc.area);
      modalClassification.textContent = classification;

      // Ø±Ø§Ø¨Ø· Ù„Ù„Ù…Ø²ÙŠØ¯
      modalMore.href = rc.maps && rc.maps.googleMaps ? rc.maps.googleMaps : `https://restcountries.com/`;
      modalMore.textContent = 'Ø¹Ø±Ø¶ ØµÙØ­Ø© REST Countries (Ù…ØµØ¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)';

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      modal.classList.remove('hidden');
    }

    // Ø¥Ø°Ø§ Ù„Ù… ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª REST Countries
    function showModalMinimal(name, feature){
      modalName.textContent = name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      modalFlag.src = '';
      modalFlag.alt = '';
      modalRegion.textContent = feature.properties.region || feature.properties.continent || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
      modalCapital.textContent = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
      modalPopulation.textContent = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
      modalArea.textContent = feature.properties.area ? feature.properties.area : 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
      modalCurrency.textContent = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
      modalLanguages.textContent = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
      modalNote.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù† Ù…ØµØ¯Ø± Ø®Ø§Ø±Ø¬ÙŠ.';
      modalClassification.textContent = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ (Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©)';
      modalMore.href = '#';
      modalMore.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
      modal.classList.remove('hidden');
    }

    // ØªØµÙ†ÙŠÙ ØªÙ‚Ø¯ÙŠØ±ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙƒØ§Ù† (Ù‚ÙˆØ§Ø¹Ø¯ Ø¨Ø³ÙŠØ·Ø© Ù„ØªÙˆØ¶ÙŠØ­ Ø§Ù„ÙÙƒØ±Ø©)
    function estimateClassification(population, area){
      // population may be undefined
      if(!population) return 'ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ‚Ø¯ÙŠØ±ÙŠ)';
      const pop = Number(population);
      if(pop >= 100_000_000) return 'Ù‚ÙˆÙŠØ© (Ø¯ÙˆÙ„Ø© ÙƒØ¨ÙŠØ±Ø© ØªØ¹Ø¯Ø§Ø¯ÙŠØ§Ù‹)';
      if(pop >= 50_000_000) return 'Ù‚ÙˆÙŠØ©/ÙƒØ¨ÙŠØ±Ø©';
      if(pop >= 10_000_000) return 'Ù…ØªÙˆØ³Ø·Ø©';
      if(pop >= 1_000_000) return 'ØµØºÙŠØ±Ø©';
      return 'Ù‡Ø§Ù…Ø´ÙŠØ© (Ù‚Ù„ÙŠÙ„Ø© Ø§Ù„Ø³ÙƒØ§Ù†)';
    }

    // Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    function numberWithCommas(x){
      if(!x && x !== 0) return x;
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // ØºÙ„Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    closeModalBtn.addEventListener('click', ()=> modal.classList.add('hidden'));
    modal.addEventListener('click', (e) => {
      if(e.target === modal) modal.classList.add('hidden');
    });

    // === Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆÙ„ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ + Ø¨Ø­Ø« + ØªØµÙÙŠØ© ===
    function populateCountryList(features){
      countryListEl.innerHTML = '';
      // Ù†Ø±ØªØ¨ Ø§Ø³Ø§Ù…ÙŠ Ø§Ù„Ø¯ÙˆÙ„ Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ø®Ø§ØµÙŠØ© name
      const arr = features.map(f => {
        return {
          name: f.properties.name || f.properties.NAME || f.properties.ADMIN || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
          props: f.properties,
          feature: f
        };
      }).sort((a,b)=> a.name.localeCompare(b.name, 'ar') );

      arr.forEach(item=>{
        const li = document.createElement('li');
        const img = document.createElement('img');
        img.className = 'country-flag-thumb';
        img.alt = `${item.name} Ø¹Ù„Ù…`;
        img.src = getFlagThumbUrl(item.props); // Ø­Ø§ÙˆÙ„ Ù†Ø¬ÙŠØ¨ Ø¹Ù„Ù… Ù…Ù† REST Countries Ø¹Ø¨Ø± Ø§Ù„ÙƒÙˆØ¯ Ù„Ùˆ Ù…ØªØ§Ø­
        const span = document.createElement('span');
        span.textContent = item.name;
        li.appendChild(img);
        li.appendChild(span);
        li.addEventListener('click', ()=>{
          // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â€” Ù†ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯ÙˆÙ„Ø©
          focusOnCountry(item.feature);
          onCountryClick(item.feature);
        });
        countryListEl.appendChild(li);
      });
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù„Ù… Ù…ØµØºØ± Ø¹Ù† Ø·Ø±ÙŠÙ‚ ISO code Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ø®ØµØ§Ø¦Øµ
    function getFlagThumbUrl(props){
      // REST Countries uses alpha2 code (ISO 3166-1 alpha-2)
      const iso_a2 = props.iso_a2 || props.ISO_A2 || props['ISO_A2'];
      if(iso_a2){
        return `https://flagcdn.com/w40/${iso_a2.toLowerCase()}.png`;
      }
      // Ø¨Ø¯ÙŠÙ„: Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† iso_a3 â€” Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø­ÙŠØ§Ù† Ù„Ø§ ÙŠØ¹Ù…Ù„ Ù…Ø¹ flagcdn
      const iso_a3 = props.iso_a3 || props.ISO_A3 || props['ISO3'];
      if(iso_a3){
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù…ÙˆØ«ÙˆÙ‚ Ù…Ù† iso3 Ù„Ø°Ù„Ùƒ Ù†Ø±Ø¬Ø¹ ØµÙˆØ±Ø© ÙØ§Ø±ØºØ© placeholder
        return 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="24"></svg>';
      }
      // placeholder Ø´ÙØ§Ù
      return 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="24"></svg>';
    }

    // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø¯ÙˆÙ„Ø© Ù…Ø­Ø¯Ø¯Ø©
    function focusOnCountry(feature) {
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¯ÙˆÙ„Ø©
      const coords = getFeatureCenter(feature);
      if (coords) {
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
        const targetPosition = latLonToVector3(coords[0], coords[1], 200);
        
        // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ø¯ÙˆÙ„Ø©
        controls.target.set(targetPosition.x, targetPosition.y, targetPosition.z);
        camera.position.set(targetPosition.x * 1.5, targetPosition.y * 1.5, targetPosition.z * 1.5);
        
        // Ø¥Ø¨Ø±Ø§Ø² Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆÙ„Ø©
        highlightCountryLabel(feature.properties.name || feature.properties.NAME || feature.properties.ADMIN);
      }
    }
    
    // Ø¥Ø¨Ø±Ø§Ø² Ø§Ø³Ù… Ø¯ÙˆÙ„Ø© Ù…Ø­Ø¯Ø¯Ø©
    function highlightCountryLabel(countryName) {
      countryLabels.forEach(labelInfo => {
        if (labelInfo.country.name === countryName || 
            labelInfo.country.NAME === countryName || 
            labelInfo.country.ADMIN === countryName) {
          labelInfo.element.classList.add('highlight');
          
          // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
          setTimeout(() => {
            labelInfo.element.classList.remove('highlight');
          }, 3000);
        }
      });
    }

    // Ø­Ø³Ø§Ø¨ Ù…Ø±ÙƒØ² ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù…Ù† Ø§Ù„Ø¨ÙˆÙ„ÙŠØºÙˆÙ† (Ø¥Ø°Ø§ Ù…ØªØ§Ø­)
    function getFeatureCenter(feature){
      try {
        const coords = feature.geometry.coordinates;
        // Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙˆÙ„ Ø²ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
        if(!coords) return null;
        function findFirstPair(arr){
          if(typeof arr[0] === 'number' && typeof arr[1] === 'number') return arr;
          for(let i=0;i<arr.length;i++){
            const r = findFirstPair(arr[i]);
            if(r) return r;
          }
          return null;
        }
        const pair = findFirstPair(coords);
        return pair ? [pair[1], pair[0]] : null;
      } catch(e){ return null; }
    }

    // Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… ÙˆØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ø±Ø©
    searchInput.addEventListener('input', filterList);
    regionFilter.addEventListener('change', filterList);

    function filterList(){
      const q = searchInput.value.trim().toLowerCase();
      const region = regionFilter.value;
      const items = countryListEl.querySelectorAll('li');
      items.forEach(li=>{
        const txt = li.textContent.trim().toLowerCase();
        let show = txt.includes(q);
        if(region && show){
          // Ù†ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆÙ† Ø§Ù„Ø¯ÙˆÙ„Ø© ÙÙŠ region Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… REST API (asynchronous) â€” Ù„ÙƒÙ† Ù‡Ù†Ø§ Ù†Ø¨Ø³Ø·: Ø¥Ø®ÙØ§Ø¡/Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…ØªÙˆÙØ± Ù…Ø­Ù„ÙŠÙ‹Ø§
          // Ù„Ø°Ù„Ùƒ ÙÙ‚Ø· Ù†Ø¸Ù‡Ø± Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø­Ø«. Ù„Ø¥Ø¶Ø§ÙØ© ÙÙ„ØªØ± Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø¨Ø¯Ù‚Ø© Ù†Ø­ØªØ§Ø¬ ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª REST Countries Ù„ÙƒÙ„ Ø¹Ù†ØµØ± Ù…Ø³Ø¨Ù‚Ù‹Ø§.
        }
        li.style.display = show ? 'flex' : 'none';
      });
    }

    // Ø¥Ø¶Ø§ÙØ© ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©
    function addGlobeInteractivity() {
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();
      
      function onMouseClick(event) {
        // Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§ÙˆØ³ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø¹Ù†ØµØ±
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        
        // ØªØ­Ø¯ÙŠØ« Raycaster
        raycaster.setFromCamera(mouse, camera);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø·Ø¹ Ù…Ø¹ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„
        const intersects = raycaster.intersectObjects(countryObjects);
        
        if (intersects.length > 0) {
          const country = intersects[0].object.userData.country;
          if (country) {
            const feature = countriesData.find(f => 
              f.properties.name === country.name || 
              f.properties.NAME === country.name || 
              f.properties.ADMIN === country.name
            );
            
            if (feature) {
              onCountryClick(feature);
              highlightCountryLabel(country.name);
            }
          }
        }
      }
      
      renderer.domElement.addEventListener('click', onMouseClick);
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('load', function() {
      initGlobe();
      window.addEventListener('resize', onWindowResize);
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆÙ„
      setTimeout(addGlobeInteractivity, 2000);
    });

    function onWindowResize() {
      camera.aspect = document.getElementById('globe').offsetWidth / document.getElementById('globe').offsetHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(document.getElementById('globe').offsetWidth, document.getElementById('globe').offsetHeight);
    }
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
    mobileMenuToggle.addEventListener('click', function() {
      sidebar.classList.toggle('hidden-mobile');
    });
  </script>
</body>
</html>
