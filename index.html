<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GeoWorld — خريطة العالم التفاعلية ثلاثية الأبعاد</title>

  <!-- Three.js و D3.js للكرة الأرضية ثلاثية الأبعاد -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.0.0/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-geo@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <!-- Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#11161a;
      --accent:#2bd4c8;
      --accent-dark:#1fa89e;
      --muted:#9aa6ad;
      --card:#172026;
      --text:#e7f6f4;
      --shadow: 0 8px 30px rgba(0,0,0,0.4);
      --success: #4CAF50;
      --warning: #FF9800;
      --danger: #F44336;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Cairo",sans-serif;
      background:linear-gradient(135deg, #071014 0%, #0b1216 100%);
      color:var(--text);
      height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    header{
      padding:16px 24px;
      background:rgba(11, 15, 20, 0.85);
      border-bottom:1px solid rgba(255,255,255,0.05);
      flex-shrink: 0;
      box-shadow: var(--shadow);
      z-index: 10;
      backdrop-filter: blur(10px);
    }
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-icon {
      font-size: 28px;
    }
    .logo-text h1{
      margin:0;
      font-size:20px;
      font-weight: 700;
    }
    .logo-text p{
      margin:4px 0 0;
      color:var(--muted);
      font-size:13px;
    }
    .header-controls {
      display: flex;
      gap: 12px;
    }
    .header-btn {
      background: rgba(43, 212, 200, 0.1);
      border: 1px solid rgba(43, 212, 200, 0.2);
      color: var(--accent);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-btn:hover {
      background: rgba(43, 212, 200, 0.2);
      transform: translateY(-2px);
    }
    .header-btn.active {
      background: rgba(43, 212, 200, 0.3);
      border-color: var(--accent);
    }

    main{
      display:flex;
      gap:16px;
      height:calc(100vh - 80px);
      padding:16px;
      flex: 1;
      min-height: 0;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    /* Sidebar */
    #sidebar{
      width:340px;
      background:var(--panel);
      border-radius:16px;
      padding:16px;
      box-shadow: var(--shadow);
      overflow:auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(255,255,255,0.03);
      transition: transform 0.3s ease;
    }
    .sidebar-header {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .sidebar-header h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 600;
    }
    .sidebar-header p {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }
    .sidebar-actions {
      display: flex;
      gap: 8px;
    }
    .sidebar-action-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .sidebar-action-btn:hover {
      background: rgba(43, 212, 200, 0.2);
      border-color: var(--accent);
    }
    .controls{display:flex;gap:10px;margin-bottom:16px}
    #search{
      flex:1;
      padding:12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(0,0,0,0.2);
      color:inherit;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    #search:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(43, 212, 200, 0.1);
    }
    #region-filter{
      padding:12px;
      border-radius:10px;
      background:rgba(0,0,0,0.2);
      border:1px solid rgba(255,255,255,0.06);
      color:inherit;
      font-family: inherit;
      cursor: pointer;
    }

    #list-container{
      flex: 1;
      overflow:auto;
      border-radius: 10px;
    }
    #country-list{
      list-style:none;
      padding:0;
      margin:0;
    }
    #country-list li{
      padding:12px;
      border-radius:10px;
      margin-bottom:8px;
      background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
      display:flex;
      align-items:center;
      gap:12px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,0.03);
      transition: all 0.2s ease;
      position: relative;
    }
    #country-list li:hover {
      background: rgba(43, 212, 200, 0.1);
      border-color: rgba(43, 212, 200, 0.2);
      transform: translateY(-2px);
    }
    #country-list li.active {
      background: rgba(43, 212, 200, 0.15);
      border-color: var(--accent);
    }
    .country-flag-thumb{
      width:40px;
      height:26px;
      border-radius:5px;
      object-fit:cover;
      border:1px solid rgba(0,0,0,0.3);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .country-fav-btn {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .country-fav-btn:hover {
      color: var(--warning);
    }
    .country-fav-btn.favorited {
      color: var(--warning);
    }

    /* Globe */
    #globe-container{
      flex:1;
      border-radius:16px;
      overflow:hidden;
      position:relative;
      min-width: 0;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.03);
    }
    #globe{
      height:100%;
      width:100%;
      background: #071014;
    }
    #globe-info {
      position: absolute;
      bottom: 16px;
      left: 16px;
      background: rgba(0,0,0,0.7);
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      color: var(--muted);
      z-index: 10;
      backdrop-filter: blur(5px);
      transition: opacity 0.3s ease;
    }
    .globe-controls {
      position: absolute;
      top: 16px;
      left: 16px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .globe-btn {
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }
    .globe-btn:hover {
      background: rgba(43, 212, 200, 0.2);
      border-color: var(--accent);
      transform: scale(1.1);
    }
    .globe-btn.active {
      background: rgba(43, 212, 200, 0.3);
      border-color: var(--accent);
    }

    /* Modal */
    #country-modal.hidden{display:none}
    #country-modal{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      background: rgba(2,6,8,0.8);
      backdrop-filter: blur(5px);
    }
    .modal-card{
      width:420px;
      background:var(--card);
      padding:20px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.05);
      box-shadow:0 20px 60px rgba(0,0,0,0.6);
      position:relative;
      text-align:right;
      max-height: 90vh;
      overflow-y: auto;
    }
    #close-modal{
      position:absolute;
      left:16px;
      top:16px;
      background:#ff5f5f;
      border:0;
      color:white;
      border-radius:50%;
      width:36px;
      height:36px;
      font-size:20px;
      cursor:pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #close-modal:hover {
      background: #ff3b3b;
      transform: scale(1.1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .modal-fav-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .modal-fav-btn:hover {
      color: var(--warning);
    }
    .modal-fav-btn.favorited {
      color: var(--warning);
    }
    #modal-flag{
      width:100%;
      height:180px;
      object-fit:cover;
      border-radius:10px;
      margin-bottom:16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .modal-card h2{
      margin:0 0 12px 0;
      font-size: 22px;
      font-weight: 700;
      color: var(--accent);
    }
    .modal-card p{
      margin:8px 0;
      color:var(--muted);
      font-size:14px;
      line-height: 1.5;
    }
    .modal-card strong {
      color: var(--text);
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    #modal-more{
      display:inline-block;
      padding:10px 16px;
      border-radius:10px;
      background:var(--accent);
      color:#012;
      text-decoration:none;
      font-weight:600;
      text-align: center;
      transition: all 0.3s ease;
      flex: 1;
    }
    #modal-more:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }
    #modal-compare {
      display:inline-block;
      padding:10px 16px;
      border-radius:10px;
      background:rgba(255,255,255,0.1);
      color:var(--text);
      text-decoration:none;
      font-weight:600;
      text-align: center;
      transition: all 0.3s ease;
      flex: 1;
      border: 1px solid rgba(255,255,255,0.1);
    }
    #modal-compare:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }

    /* تنسيق أسماء الدول على الكرة الأرضية */
    .country-label {
      position: absolute;
      color: white;
      font-family: 'Cairo', sans-serif;
      font-size: 12px;
      font-weight: 500;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
      pointer-events: none;
      white-space: nowrap;
      transition: all 0.3s ease;
      z-index: 5;
      background: rgba(0,0,0,0.5);
      padding: 2px 6px;
      border-radius: 4px;
      backdrop-filter: blur(2px);
    }
    
    .country-label.highlight {
      color: var(--accent);
      font-weight: 700;
      font-size: 14px;
      text-shadow: 0 0 10px rgba(43, 212, 200, 0.8);
      background: rgba(0,0,0,0.7);
      transform: scale(1.1);
    }
    
    /* زر القائمة المتنقلة للشاشات الصغيرة */
    #mobile-menu-toggle {
      display: none;
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      color: #012;
      font-size: 20px;
      cursor: pointer;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    
    #mobile-menu-toggle:hover {
      background: var(--accent-dark);
      transform: scale(1.1);
    }
    
    @media (max-width: 900px) {
      #mobile-menu-toggle {
        display: block;
      }
      
      #sidebar.hidden-mobile {
        transform: translateX(100%);
      }
    }

    /* مؤشر التحميل */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      flex-direction: column;
      gap: 16px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(43, 212, 200, 0.2);
      border-left: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* شريط التقدم */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    /* إشعارات */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 12px 16px;
      box-shadow: var(--shadow);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 300px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .notification-icon {
      font-size: 18px;
    }
    
    .notification.success .notification-icon {
      color: var(--success);
    }
    
    .notification.warning .notification-icon {
      color: var(--warning);
    }
    
    .notification.error .notification-icon {
      color: var(--danger);
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      margin: 0 0 4px 0;
      font-size: 14px;
    }
    
    .notification-message {
      margin: 0;
      font-size: 13px;
      color: var(--muted);
    }
    
    .notification-close {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 16px;
    }

    /* علامات التبويب */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .tab {
      padding: 8px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      flex: 1;
      text-align: center;
    }
    
    .tab.active {
      background: rgba(43, 212, 200, 0.2);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    /* تحسينات التمرير */
    #list-container::-webkit-scrollbar {
      width: 6px;
    }
    
    #list-container::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 3px;
    }
    
    #list-container::-webkit-scrollbar-thumb {
      background: rgba(43, 212, 200, 0.3);
      border-radius: 3px;
    }
    
    #list-container::-webkit-scrollbar-thumb:hover {
      background: rgba(43, 212, 200, 0.5);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      main {
        gap: 12px;
        padding: 12px;
      }
      
      #sidebar {
        width: 300px;
      }
    }
    
    @media (max-width: 900px){
      .header-content {
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }
      
      main {
        flex-direction: column;
        height: auto;
        gap: 12px;
      }
      
      #sidebar {
        width: 100%;
        max-height: 40vh;
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        z-index: 99;
        transform: translateX(0);
      }
      
      #globe-container {
        min-height: 50vh;
      }
    }
    
    @media (max-width: 600px){
      header {
        padding: 12px 16px;
      }
      
      .logo-text h1 {
        font-size: 18px;
      }
      
      .logo-text p {
        font-size: 12px;
      }
      
      .header-btn {
        padding: 6px 12px;
        font-size: 13px;
      }
      
      main {
        padding: 10px;
        gap: 10px;
      }
      
      .modal-card {
        width: 95%;
        padding: 16px;
        margin: 10px;
      }
      
      .controls {
        flex-direction: column;
      }
    }
    
    @media (max-width: 400px){
      main {
        padding: 8px;
      }
      
      #sidebar {
        padding: 12px;
      }
      
      #country-list li {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">🌍</div>
        <div class="logo-text">
          <h1>GeoWorld — خريطة العالم التفاعلية</h1>
          <p>استكشف العالم بضغطة زر - اضغط على أي دولة لعرض معلوماتها</p>
        </div>
      </div>
      <div class="header-controls">
        <button class="header-btn" id="reset-view">
          <i class="fas fa-sync-alt"></i>
          إعادة تعيين العرض
        </button>
        <button class="header-btn" id="toggle-labels">
          <i class="fas fa-tag"></i>
          إظهار/إخفاء الأسماء
        </button>
        <button class="header-btn" id="toggle-favorites">
          <i class="fas fa-star"></i>
          المفضلة
        </button>
      </div>
    </div>
  </header>

  <main>
    <button id="mobile-menu-toggle">☰</button>
    
    <aside id="sidebar">
      <div class="sidebar-header">
        <div>
          <h2>قائمة الدول</h2>
          <p>ابحث عن دولة أو قم بتصفية النتائج حسب المنطقة</p>
        </div>
        <div class="sidebar-actions">
          <button class="sidebar-action-btn" id="toggle-favorites-view" title="عرض المفضلة فقط">
            <i class="fas fa-star"></i>
          </button>
          <button class="sidebar-action-btn" id="clear-filters" title="مسح الفلاتر">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="tabs">
        <div class="tab active" data-tab="all">جميع الدول</div>
        <div class="tab" data-tab="favorites">المفضلة</div>
      </div>

      <div class="controls">
        <input id="search" type="search" placeholder="ابحث عن دولة بالاسم..." />
        <select id="region-filter">
          <option value="">كل القارات / المناطق</option>
          <option value="Africa">أفريقيا</option>
          <option value="Americas">الأمريكيتان</option>
          <option value="Asia">آسيا</option>
          <option value="Europe">أوروبا</option>
          <option value="Oceania">أوقيانوسيا</option>
          <option value="Polar">القطب</option>
        </select>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="loading-progress" style="width: 0%"></div>
      </div>

      <div id="list-container">
        <div class="loading">
          <div class="spinner"></div>
          <p>جاري تحميل بيانات الدول...</p>
        </div>
        <ul id="country-list" style="display: none;"></ul>
        <div id="favorite-countries" style="display: none;"></div>
      </div>
    </aside>

    <section id="globe-container">
      <div class="globe-controls">
        <button class="globe-btn" id="zoom-in" title="تكبير">
          <i class="fas fa-search-plus"></i>
        </button>
        <button class="globe-btn" id="zoom-out" title="تصغير">
          <i class="fas fa-search-minus"></i>
        </button>
        <button class="globe-btn" id="reset-rotation" title="إعادة التدوير">
          <i class="fas fa-redo"></i>
        </button>
        <button class="globe-btn" id="toggle-auto-rotate" title="التدوير التلقائي">
          <i class="fas fa-sync"></i>
        </button>
      </div>
      <div id="globe"></div>
      <div id="globe-info">استخدم الماوس للتحكم في الكرة الأرضية: تدوير، تكبير/تصغير</div>
    </section>
  </main>

  <!-- نافذة معلومات الدولة -->
  <div id="country-modal" class="hidden">
    <div class="modal-card">
      <button id="close-modal" title="إغلاق">×</button>
      <div class="modal-header">
        <h2 id="modal-name"></h2>
        <button class="modal-fav-btn" id="modal-favorite" title="إضافة إلى المفضلة">
          <i class="far fa-star"></i>
        </button>
      </div>
      <img id="modal-flag" alt="علم الدولة" />
      <p><strong>📍 الموقع الجغرافي:</strong> <span id="modal-region"></span></p>
      <p><strong>🏙️ العاصمة:</strong> <span id="modal-capital"></span></p>
      <p><strong>👥 السكان:</strong> <span id="modal-population"></span></p>
      <p><strong>📏 المساحة (كم²):</strong> <span id="modal-area"></span></p>
      <p><strong>💱 العملة:</strong> <span id="modal-currency"></span></p>
      <p><strong>📝 اللغات:</strong> <span id="modal-languages"></span></p>
      <p><strong>📖 نبذة موجزة:</strong> <span id="modal-note"></span></p>
      <p><strong>⚖️ التصنيف (تقديري):</strong> <span id="modal-classification"></span></p>
      <div class="modal-actions">
        <a id="modal-more" target="_blank" rel="noopener">عرض معلومات إضافية</a>
        <button id="modal-compare">مقارنة</button>
      </div>
    </div>
  </div>

  <!-- إشعارات -->
  <div class="notification" id="notification">
    <div class="notification-icon">
      <i class="fas fa-info-circle"></i>
    </div>
    <div class="notification-content">
      <div class="notification-title" id="notification-title"></div>
      <div class="notification-message" id="notification-message"></div>
    </div>
    <button class="notification-close" id="notification-close">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <script>
    // === إعداد الكرة الأرضية ثلاثية الأبعاد ===
    let scene, camera, renderer, globe, controls;
    let countriesData = [];
    let countryObjects = [];
    let countryLabels = [];
    let labelsVisible = true;
    let autoRotate = false;
    let favorites = JSON.parse(localStorage.getItem('geoWorldFavorites')) || [];
    let currentView = 'all'; // 'all' أو 'favorites'

    // إظهار الإشعارات
    function showNotification(title, message, type = 'info', duration = 5000) {
      const notification = document.getElementById('notification');
      const notificationTitle = document.getElementById('notification-title');
      const notificationMessage = document.getElementById('notification-message');
      
      notification.className = `notification ${type}`;
      notificationTitle.textContent = title;
      notificationMessage.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    // إغلاق الإشعار
    document.getElementById('notification-close').addEventListener('click', function() {
      document.getElementById('notification').classList.remove('show');
    });

    function initGlobe() {
      // إنشاء المشهد
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x071014);

      // إنشاء الكاميرا
      const container = document.getElementById('globe');
      camera = new THREE.PerspectiveCamera(60, container.offsetWidth / container.offsetHeight, 0.1, 2000);
      camera.position.z = 400;

      // إنشاء العارض
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(container.offsetWidth, container.offsetHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // تحسين الأداء
      container.appendChild(renderer.domElement);

      // إضافة عناصر التحكم
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.rotateSpeed = 0.5;
      controls.minDistance = 200;
      controls.maxDistance = 800;
      controls.autoRotate = autoRotate;

      // إضافة الضوء
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 3, 5);
      scene.add(directionalLight);

      // إنشاء الكرة الأرضية
      createGlobe();

      // بدء التقديم
      animate();
    }

    function createGlobe() {
      // إنشاء كرة الأرض
      const geometry = new THREE.SphereGeometry(100, 64, 64);
      const textureLoader = new THREE.TextureLoader();
      
      // تحميل نسيج الأرض
      textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/earth_atmos_2048.jpg', function(texture) {
        const material = new THREE.MeshPhongMaterial({
          map: texture,
          specular: new THREE.Color(0x333333),
          shininess: 5
        });
        globe = new THREE.Mesh(geometry, material);
        scene.add(globe);

        // إضافة السحب
        textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/planets/earth_clouds_1024.png', function(cloudTexture) {
          const cloudMaterial = new THREE.MeshPhongMaterial({
            map: cloudTexture,
            transparent: true,
            opacity: 0.4
          });
          const cloudGeometry = new THREE.SphereGeometry(101, 64, 64);
          const clouds = new THREE.Mesh(cloudGeometry, cloudMaterial);
          scene.add(clouds);
        });

        // تحميل بيانات الدول ورسم حدودها
        loadCountriesData();
      });
    }

    function loadCountriesData() {
      const GEOJSON_URL = 'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json';
      
      fetch(GEOJSON_URL)
        .then(resp => resp.json())
        .then(geo => {
          countriesData = geo.features;
          drawCountryBorders(geo);
          createCountryLabels(geo);
          populateCountryList(geo.features);
          
          // إخفاء مؤشر التحميل وإظهار القائمة
          document.querySelector('.loading').style.display = 'none';
          document.getElementById('country-list').style.display = 'block';
          
          showNotification('تم التحميل', 'تم تحميل بيانات جميع الدول بنجاح', 'success');
        })
        .catch(err => {
          console.error('فشل تحميل GeoJSON:', err);
          document.querySelector('.loading p').textContent = 'حدث خطأ في تحميل البيانات. تأكد من اتصالك بالإنترنت.';
          showNotification('خطأ في التحميل', 'تعذر تحميل بيانات الدول', 'error');
        });
    }

    // باقي الكود يتبع نفس النمط مع إضافة الميزات الجديدة...

    // إضافة المفضلة
    function toggleFavorite(countryName, countryData) {
      const index = favorites.findIndex(fav => fav.name === countryName);
      
      if (index === -1) {
        favorites.push({
          name: countryName,
          data: countryData,
          addedAt: new Date().toISOString()
        });
        showNotification('تمت الإضافة', `تمت إضافة ${countryName} إلى المفضلة`, 'success');
      } else {
        favorites.splice(index, 1);
        showNotification('تمت الإزالة', `تمت إزالة ${countryName} من المفضلة`, 'info');
      }
      
      localStorage.setItem('geoWorldFavorites', JSON.stringify(favorites));
      updateFavoritesUI();
    }

    // تحديث واجهة المفضلة
    function updateFavoritesUI() {
      const favoriteButtons = document.querySelectorAll('.country-fav-btn, .modal-fav-btn');
      favoriteButtons.forEach(btn => {
        const countryName = btn.dataset.country;
        if (favorites.some(fav => fav.name === countryName)) {
          btn.classList.add('favorited');
          btn.innerHTML = '<i class="fas fa-star"></i>';
        } else {
          btn.classList.remove('favorited');
          btn.innerHTML = '<i class="far fa-star"></i>';
        }
      });
      
      // تحديث قائمة المفضلة إذا كانت معروضة
      if (currentView === 'favorites') {
        showFavoritesView();
      }
    }

    // عرض المفضلة
    function showFavoritesView() {
      const favoritesList = document.getElementById('favorite-countries');
      const countryList = document.getElementById('country-list');
      
      if (currentView === 'favorites') {
        favoritesList.innerHTML = '';
        
        if (favorites.length === 0) {
          favoritesList.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">لا توجد دول في المفضلة</p>';
        } else {
          favorites.forEach(fav => {
            const li = createCountryListItem(fav.data);
            favoritesList.appendChild(li);
          });
        }
        
        favoritesList.style.display = 'block';
        countryList.style.display = 'none';
      } else {
        favoritesList.style.display = 'none';
        countryList.style.display = 'block';
      }
    }

    // تهيئة التطبيق
    window.addEventListener('load', function() {
      initGlobe();
      setupEventListeners();
      updateFavoritesUI();
      
      // إضافة مؤشر التحميل
      simulateLoadingProgress();
    });

    // محاكاة تقدم التحميل
    function simulateLoadingProgress() {
      let progress = 0;
      const progressBar = document.getElementById('loading-progress');
      const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
        }
        progressBar.style.width = `${progress}%`;
      }, 200);
    }

    // إعداد مستمعي الأحداث
    function setupEventListeners() {
      // البحث والتصفية
      document.getElementById('search').addEventListener('input', filterCountries);
      document.getElementById('region-filter').addEventListener('change', filterCountries);
      
      // إعادة تعيين العرض
      document.getElementById('reset-view').addEventListener('click', resetView);
      
      // التحكم في الكرة الأرضية
      document.getElementById('zoom-in').addEventListener('click', () => {
        controls.dollyOut(0.5);
        controls.update();
      });
      
      document.getElementById('zoom-out').addEventListener('click', () => {
        controls.dollyIn(0.5);
        controls.update();
      });
      
      document.getElementById('reset-rotation').addEventListener('click', () => {
        controls.reset();
      });
      
      document.getElementById('toggle-auto-rotate').addEventListener('click', () => {
        autoRotate = !autoRotate;
        controls.autoRotate = autoRotate;
        document.getElementById('toggle-auto-rotate').classList.toggle('active', autoRotate);
      });
      
      // إظهار/إخفاء الأسماء
      document.getElementById('toggle-labels').addEventListener('click', () => {
        labelsVisible = !labelsVisible;
        toggleCountryLabels(labelsVisible);
        document.getElementById('toggle-labels').classList.toggle('active', labelsVisible);
      });
      
      // المفضلة
      document.getElementById('toggle-favorites').addEventListener('click', () => {
        currentView = currentView === 'all' ? 'favorites' : 'all';
        document.getElementById('toggle-favorites').classList.toggle('active', currentView === 'favorites');
        showFavoritesView();
      });
      
      document.getElementById('toggle-favorites-view').addEventListener('click', () => {
        currentView = currentView === 'all' ? 'favorites' : 'all';
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.tab === currentView);
        });
        showFavoritesView();
      });
      
      // علامات التبويب
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentView = tab.dataset.tab;
          showFavoritesView();
        });
      });
      
      // مسح الفلاتر
      document.getElementById('clear-filters').addEventListener('click', () => {
        document.getElementById('search').value = '';
        document.getElementById('region-filter').value = '';
        filterCountries();
      });
      
      // القائمة المتنقلة
      document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('hidden-mobile');
      });
      
      // إغلاق النافذة المنبثقة
      document.getElementById('close-modal').addEventListener('click', () => {
        document.getElementById('country-modal').classList.add('hidden');
      });
      
      // إعادة ضبط الحجم عند تغيير حجم النافذة
      window.addEventListener('resize', onWindowResize);
    }

    // باقي الدوال الأساسية للكرة الأرضية...

    // ملاحظة: هذا الكود مبسط للعرض، في التطبيق الحقيقي ستحتاج إلى إكمال جميع الدوال المذكورة
  </script>
</body>
</html>
